<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Multiplayer Reaction Timer — Clean</title>
<style>
  :root{
    --bg:#0f1720; --panel:#111827; --accent:#06b6d4;
  }
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,'Helvetica Neue',Arial;}
  body{
    background: radial-gradient(1200px 600px at 10% 10%, #072033 0%, var(--bg) 20%),
                linear-gradient(180deg, rgba(255,255,255,0.02), transparent 30%);
    color:#e6eef6; display:flex; gap:20px; padding:26px; box-sizing:border-box;
  }
  .wrap{margin:auto; width:100%; max-width:1000px;}
  header {display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom:16px;}
  h1{font-size:1.35rem; margin:0;}
  .controls{display:flex; gap:12px; align-items:center; flex-wrap:wrap;}
  select,button{padding:8px;border-radius:8px;border:none;background:var(--accent);color:#042024;font-weight:600;cursor:pointer;}
  button:disabled{opacity:0.5;cursor:not-allowed;}
  .grid{display:grid; grid-template-columns: 1fr 200px; gap:18px; align-items:start;}
  .panel{background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent); border-radius:12px; padding:16px; box-shadow: 0 4px 18px rgba(2,6,23,0.7);}
  #gameBox{
    height:260px; display:flex; align-items:center; justify-content:center; border-radius:12px; cursor:pointer;
    background:#111827; font-size:1.35rem; user-select:none; transition:transform .18s ease, box-shadow .18s ease, background .18s ease;
    box-shadow: 0 8px 40px rgba(2,6,23,0.65);
  }
  #gameBox.waiting{background:linear-gradient(180deg,#2b3340,#111827);}
  #gameBox.ready{background:linear-gradient(180deg,#064e3b,#10b981); transform:scale(1.03); box-shadow:0 12px 50px rgba(16,185,129,0.18);}
  #gameBox.tooSoon{background:linear-gradient(180deg,#581c1c,#ef4444);}
  #gameBox.small{font-size:1rem}
  .config {display:flex; gap:10px; margin-top:12px; flex-wrap:wrap;}
  .player-config{display:flex;flex-direction:column; gap:8px; padding:10px; border-radius:8px;background:rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.03);}
  .stats-list{display:flex;flex-direction:column; gap:10px; margin-top:12px;}
  .pstats{padding:8px; font-weight:700;}
  .highlight{color:var(--accent); font-weight:700;}
  .winner-badge{display:inline-block;padding:6px 10px;border-radius:999px;background:linear-gradient(90deg,#f59e0b,#ef4444); color:#04111a; font-weight:700;}
  .leaderboard{margin-top:12px; border-radius:8px; padding:10px; background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent); border:1px solid rgba(255,255,255,0.03);}
  .lb-row{display:flex;justify-content:space-between; padding:8px; border-radius:6px; align-items:center;}
  .lb-row.top{background:linear-gradient(90deg, rgba(6,182,212,0.06), rgba(16,185,129,0.03)); transform:scale(1.01);}
  footer{margin-top:14px; display:flex; gap:10px; align-items:center; justify-content:space-between;}
  .winner-animate{animation:pop .8s ease;}
  @keyframes pop{0%{transform:scale(.75) rotate(-8deg)}50%{transform:scale(1.12) rotate(6deg)}100%{transform:scale(1) rotate(0)}}
  @media (max-width:920px){ .grid{grid-template-columns:1fr; } #gameBox{height:200px;} }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>⚡ Multiplayer Reaction Timer</h1>
    <div class="controls">
      <label>Players:
        <select id="playerCount">
          <option value="1">1</option><option value="2">2</option><option value="3">3</option>
          <option value="4">4</option><option value="5">5</option>
        </select>
      </label>
      <button id="startBtn">Start Turn</button>
      <button id="nextRoundBtn">End Round & Leaderboard</button>
      <button id="resetBtn">Reset All Scores</button>
    </div>
  </header>

  <div class="grid">
    <div class="panel">
      <div id="gameBox" class="waiting small">Click Start or press <strong>SPACE</strong></div>
      <div id="delayInfo" class="small-muted" style="margin-top:8px;text-align:center;"></div>
      <div class="config" id="configArea"></div>
      <footer>
        <div class="small-muted">Last action: <span id="status">Idle</span></div>
        <div class="small-muted">Current turn: <span id="currentTurn">Player 1</span></div>
      </footer>
    </div>

    <aside class="panel">
      <h3 style="margin:0 0 8px 0">Players</h3>
      <div id="playersStats" class="stats-list"></div>

      <div class="leaderboard" id="leaderboard" style="display:none;">
        <h4 style="margin:0 0 8px 0">Round Leaderboard</h4>
        <div id="leaderboardRows"></div>
        <div style="margin-top:8px;display:flex;gap:8px;">
          <button id="closeLbBtn">Close</button>
          <button id="saveRoundBtn">Save Round Results</button>
        </div>
      </div>
    </aside>
  </div>
</div>

<script>
const playerCountSelect=document.getElementById('playerCount');
const configArea=document.getElementById('configArea');
const playersStats=document.getElementById('playersStats');
const gameBox=document.getElementById('gameBox');
const startBtn=document.getElementById('startBtn');
const nextRoundBtn=document.getElementById('nextRoundBtn');
const resetBtn=document.getElementById('resetBtn');
const statusEl=document.getElementById('status');
const currentTurnEl=document.getElementById('currentTurn');
const delayInfo=document.getElementById('delayInfo');

const leaderboard=document.getElementById('leaderboard');
const leaderboardRows=document.getElementById('leaderboardRows');
const closeLbBtn=document.getElementById('closeLbBtn');
const saveRoundBtn=document.getElementById('saveRoundBtn');

let numPlayers=parseInt(playerCountSelect.value);
let currentPlayer=1;
let isWaitingForGreen=false;
let greenStartTime=null;
let greenTimeout=null;
let roundResults=[];
let players={};
let sharedDelay=null;

function buildPlayers(n){
  const old=players; players={};
  for(let i=1;i<=n;i++){
    const key='p'+i;
    players[key]=old[key]||{name:`Player ${i}`};
  }
}

function renderConfigs(){
  configArea.innerHTML='';
  for(let i=1;i<=numPlayers;i++){
    const p=players['p'+i];
    const div=document.createElement('div');
    div.className='player-config';
    div.innerHTML=`<div style="font-weight:700">${p.name}</div>`;
    configArea.appendChild(div);
  }
}

function renderStats(){
  playersStats.innerHTML='';
  for(let i=1;i<=numPlayers;i++){
    const p=players['p'+i];
    const row=document.createElement('div');
    row.className='pstats';
    row.innerHTML=`${p.name} ${i===currentPlayer?'<span class="highlight">(turn)</span>':''}`;
    playersStats.appendChild(row);
  }
}

function computeSharedDelay(){
  const minDelay=2000,maxDelay=5000;
  sharedDelay=Math.round(Math.random()*(maxDelay-minDelay)+minDelay);
  delayInfo.textContent=`This round's delay: ${sharedDelay} ms (~${(sharedDelay/1000).toFixed(2)}s)`;
}

function startTurn(){
  if(isWaitingForGreen) return;
  if(sharedDelay===null) computeSharedDelay();
  const playerKey='p'+currentPlayer;
  clearTimeout(greenTimeout);
  isWaitingForGreen=true;
  gameBox.className='waiting small';
  gameBox.textContent=`${players[playerKey].name} — Wait for green...`;
  startBtn.disabled=true; nextRoundBtn.disabled=true;
  statusEl.textContent=`Waiting ${sharedDelay}ms before green...`;
  greenTimeout=setTimeout(()=>{
    gameBox.className='ready';
    gameBox.textContent='CLICK NOW!';
    greenStartTime=performance.now();
    statusEl.textContent='React!';
  }, sharedDelay);
}

function playerReact(){
  if(!isWaitingForGreen && !greenStartTime) return;
  if(isWaitingForGreen && gameBox.className.indexOf('ready')===-1){
    clearTimeout(greenTimeout); isWaitingForGreen=false; greenStartTime=null;
    gameBox.className='tooSoon'; gameBox.textContent='Too Soon!';
    statusEl.textContent=`${players['p'+currentPlayer].name} clicked too soon`;
    startBtn.disabled=false; nextRoundBtn.disabled=false;
    setTimeout(resetBox,1000); return;
  }
  if(isWaitingForGreen && greenStartTime){
    const rt=Math.round(performance.now()-greenStartTime);
    roundResults.push({player:currentPlayer,time:rt});
    gameBox.className='waiting small';
    gameBox.textContent=`${players['p'+currentPlayer].name}: ${rt} ms`;
    statusEl.textContent=`${players['p'+currentPlayer].name} reacted (${rt} ms)`;
    isWaitingForGreen=false; greenStartTime=null;
    setTimeout(()=>{
      currentPlayer++;
      if(currentPlayer>numPlayers){
        currentPlayer=1;
        statusEl.textContent='Round complete — press "End Round & Leaderboard"';
        startBtn.disabled=true; nextRoundBtn.disabled=false;
      }else{
        statusEl.textContent=`Ready for ${players['p'+currentPlayer].name}`;
        startBtn.disabled=false;
      }
      renderStats();
      currentTurnEl.textContent=`Player ${currentPlayer}`;
    },500);
    renderStats();
  }
}

function resetBox(){
  gameBox.className='waiting small';
  gameBox.textContent='Click Start or press SPACE';
  statusEl.textContent='Idle';
  startBtn.disabled=false; nextRoundBtn.disabled=false;
}

function showLeaderboard(){
  if(roundResults.length===0){ alert('No results yet'); return; }
  const sorted=[...roundResults].sort((a,b)=>a.time-b.time);
  leaderboardRows.innerHTML='';
  sorted.forEach((r,idx)=>{
    const playerName=players['p'+r.player].name;
    const row=document.createElement('div');
    row.className='lb-row'+(idx===0?' top':'');
    row.innerHTML=`<div style="font-weight:700">${idx+1}. ${playerName}</div>
      <div style="text-align:right">${r.time} ms</div>`;
    leaderboardRows.appendChild(row);
  });
  const winner=sorted[0];
  const badge=document.createElement('div');
  badge.className='winner-badge winner-animate';
  badge.textContent=`🏆 ${players['p'+winner.player].name} wins!`;
  leaderboardRows.prepend(badge);
  leaderboard.style.display='block';
}

function saveRound(){
  roundResults=[]; leaderboard.style.display='none';
  sharedDelay=null; currentPlayer=1;
  renderStats(); resetBox();
}

function resetAll(){
  if(confirm('Reset all scores?')){
    roundResults=[]; sharedDelay=null; currentPlayer=1;
    leaderboard.style.display='none'; renderStats(); resetBox();
  }
}

startBtn.addEventListener('click', startTurn);
nextRoundBtn.addEventListener('click', showLeaderboard);
resetBtn.addEventListener('click', resetAll);
closeLbBtn.addEventListener('click',()=>{leaderboard.style.display='none';});
saveRoundBtn.addEventListener('click', saveRound);

gameBox.addEventListener('click', ()=>{
  if(!isWaitingForGreen && !startBtn.disabled){ startTurn(); return; }
  playerReact();
});
document.addEventListener('keydown', e=>{
  if(e.code==='Space'){ e.preventDefault(); if(!isWaitingForGreen && !startBtn.disabled){ startTurn(); return; } playerReact(); }
});

playerCountSelect.addEventListener('change', ()=>{
  numPlayers=parseInt(playerCountSelect.value);
  buildPlayers(numPlayers);
  renderConfigs();
  renderStats();
  resetBox();
});

(function init(){
  buildPlayers(numPlayers);
  renderConfigs();
  renderStats();
})();
</script>
</body>
</html>
